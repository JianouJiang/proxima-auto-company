<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Calm anxiety in 60 seconds with science-backed breathing exercises. Free guided breathing app that works instantly. No signup required.">
  <meta name="theme-color" content="#FFF1E0">
  <meta name="google-site-verification" content="x8IioRNoRz78j7yTBORUahNaCNsZMT2JETgc91w7y0M" />
  <title>Calm Anxiety in 60 Seconds | Double Mood â€” Free Breathing Exercise</title>

  <!-- Open Graph Meta Tags -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Calm Anxiety in 60 Seconds | Double Mood">
  <meta property="og:description" content="Science-backed breathing exercises that calm anxiety instantly. Free, no signup required.">
  <meta property="og:url" content="https://double-mood.pages.dev/">
  <meta property="og:image" content="https://double-mood.pages.dev/og-image.jpg">

  <!-- Twitter Card Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Calm Anxiety in 60 Seconds | Double Mood">
  <meta name="twitter:description" content="Science-backed breathing exercises that calm anxiety instantly. Free, no signup required.">
  <meta name="twitter:image" content="https://double-mood.pages.dev/og-image.jpg">

  <!-- Language Tags -->
  <link rel="alternate" hreflang="en" href="https://double-mood.pages.dev/">
  <link rel="alternate" hreflang="zh" href="https://double-mood.pages.dev/">

  <!-- Schema.org Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Double Mood",
    "description": "Free breathing exercise app to calm anxiety in 60 seconds",
    "url": "https://double-mood.pages.dev/",
    "applicationCategory": "HealthApplication",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    },
    "featureList": ["Guided breathing exercises", "Mood tracking", "Anxiety relief", "Science-backed techniques"],
    "operatingSystem": "Web Browser"
  }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            // Phase 1 Foundation
            'breath-bg': '#FFF1E0',
            'breath-primary': '#4A90E2',
            'breath-accent': '#50C9B8',
            'breath-text': '#2C3E50',
            'breath-muted': '#7B8B9A',
            'mood-before': '#E57373',
            'mood-after': '#81C784',
            // Phase 2 Weather Palettes
            'sunny-base': '#FFD700',
            'sunny-highlight': '#FFA500',
            'sunny-light': '#FFF9E6',
            'sunny-text': '#8B6914',
            'cloudy-base': '#B0B0B0',
            'cloudy-dark': '#808080',
            'cloudy-light': '#E8E8E8',
            'cloudy-text': '#4A4A4A',
            'foggy-base': '#A8DADC',
            'foggy-dark': '#457B9D',
            'foggy-light': '#E3F2F4',
            'foggy-text': '#1D3557',
            'stormy-base': '#5A189A',
            'stormy-accent': '#C1121F',
            'stormy-light': '#E8D7F1',
            'stormy-text': '#3D0066',
          }
        }
      }
    }
  </script>
  <style>
    /* Screen Reader Only */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* Language Toggle */
    .hidden { display: none !important; }

    .lang-toggle {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 50;
      padding: 8px 18px;
      background: #4A90E2;
      color: #fff;
      border: none;
      border-radius: 9999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(74, 144, 226, 0.35);
      transition: background 200ms, transform 200ms;
      letter-spacing: 0.5px;
    }
    .lang-toggle:hover {
      background: #3a7bc8;
      transform: scale(1.05);
    }
    .lang-toggle:active {
      transform: scale(0.97);
    }
    @media (max-width: 640px) {
      .lang-toggle {
        top: 10px;
        right: 10px;
        padding: 6px 14px;
        font-size: 13px;
      }
    }

    /* Weather Card Animations */
    @keyframes sunnyPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes cloudyDrift {
      0%, 100% { transform: translateX(0); }
      50% { transform: translateX(4px); }
    }
    @keyframes foggyFade {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    @keyframes stormyShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }

    .weather-card:hover .emoji.sunny { animation: sunnyPulse 1s ease-in-out infinite; }
    .weather-card:hover .emoji.cloudy { animation: cloudyDrift 2s ease-in-out infinite; }
    .weather-card:hover .emoji.foggy { animation: foggyFade 2s ease-in-out infinite; }
    .weather-card:hover .emoji.stormy { animation: stormyShake 0.5s ease-in-out; }

    /* Sedona Wave Float */
    @keyframes waveFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }
    .sedona-wave { animation: waveFloat 2s cubic-bezier(0.4, 0.0, 0.2, 1) infinite; }

    @keyframes waveExpand {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(3); opacity: 0; }
    }

    /* Slide Transitions */
    @keyframes slideOutLeft {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(-100%); opacity: 0; }
    }
    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .screen-exit { animation: slideOutLeft 300ms cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }
    .screen-enter { animation: slideInRight 300ms cubic-bezier(0.4, 0.0, 0.2, 1) forwards; }

    /* Breathing Circle */
    .breath-circle {
      filter: drop-shadow(0 4px 12px rgba(74, 144, 226, 0.15));
    }

    /* Intensity Slider */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 12px;
      border-radius: 6px;
      outline: none;
      cursor: pointer;
      transition: background 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      border: 4px solid #4A90E2;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    input[type="range"]::-webkit-slider-thumb:hover {
      border-color: #3a7bc8;
      transform: scale(1.1);
    }

    input[type="range"]::-webkit-slider-thumb:active {
      transform: scale(0.95);
    }

    input[type="range"]::-moz-range-thumb {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: white;
      border: 4px solid #4A90E2;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transition: all 200ms cubic-bezier(0.4, 0.0, 0.2, 1);
    }

    input[type="range"]::-moz-range-thumb:hover {
      border-color: #3a7bc8;
      transform: scale(1.1);
    }

    input[type="range"]::-moz-range-thumb:active {
      transform: scale(0.95);
    }

    input[type="range"]:focus-visible {
      outline: 2px solid #4A90E2;
      outline-offset: 4px;
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      .weather-card:hover .emoji,
      .sedona-wave,
      .screen-exit,
      .screen-enter {
        animation: none !important;
      }
      .breath-pulse animate {
        animation: none !important;
      }
      input[type="range"]::-webkit-slider-thumb:hover,
      input[type="range"]::-moz-range-thumb:hover {
        transform: none;
      }
    }
  </style>
</head>
<body class="bg-breath-bg text-breath-text min-h-screen flex items-center">

  <!-- Language Toggle Button -->
  <button class="lang-toggle" onclick="toggleLanguage()">EN / ä¸­æ–‡</button>

  <!-- Hero Section (SEO) -->
  <section id="hero" class="max-w-2xl mx-auto px-4 py-12 text-center">
    <h1 class="text-3xl md:text-4xl font-bold text-breath-text mb-4">
      <span class="lang-en">Calm Anxiety in 60 Seconds</span><span class="lang-zh hidden">60ç§’å¹³å¤ç„¦è™‘</span>
    </h1>
    <p class="text-lg md:text-xl text-breath-text mb-6 leading-relaxed">
      <span class="lang-en">When anxiety hits, you don't need another meditation app. You need <strong>emotional first-aid that works instantly</strong>.</span><span class="lang-zh hidden">å½“ç„¦è™‘æ¥è¢­æ—¶ï¼Œä½ ä¸éœ€è¦å¦ä¸€ä¸ªå†¥æƒ³åº”ç”¨ã€‚ä½ éœ€è¦çš„æ˜¯<strong>ç«‹å³ç”Ÿæ•ˆçš„æƒ…ç»ªæ€¥æ•‘</strong>ã€‚</span>
    </p>
    <p class="text-base text-breath-muted mb-8 leading-relaxed max-w-xl mx-auto">
      <span class="lang-en">Double Mood uses science-backed breathing techniques to activate your parasympathetic nervous system â€” the body's natural "calm down" switch. No account, no downloads, just breathe.</span><span class="lang-zh hidden">Double Mood ä½¿ç”¨ç§‘å­¦éªŒè¯çš„å‘¼å¸æŠ€æœ¯æ¿€æ´»ä½ çš„å‰¯äº¤æ„Ÿç¥ç»ç³»ç»Ÿâ€”â€”èº«ä½“å¤©ç„¶çš„"å¹³é™"å¼€å…³ã€‚æ— éœ€è´¦æˆ·ï¼Œæ— éœ€ä¸‹è½½ï¼Œåªéœ€å‘¼å¸ã€‚</span>
    </p>
    <a href="#app" class="inline-block px-8 py-4 bg-breath-primary hover:bg-breath-primary/90 text-white text-lg font-medium rounded-lg transition shadow-lg">
      <span class="lang-en">Try It Free â€” It's Instant</span><span class="lang-zh hidden">å…è´¹è¯•ç”¨ â€” å³åˆ»è§æ•ˆ</span>
    </a>
    <p class="text-sm text-breath-muted mt-4">
      <span class="lang-en">âœ“ Free forever &nbsp; âœ“ No signup &nbsp; âœ“ Works offline</span><span class="lang-zh hidden">âœ“ æ°¸ä¹…å…è´¹ &nbsp; âœ“ æ— éœ€æ³¨å†Œ &nbsp; âœ“ ç¦»çº¿å¯ç”¨</span>
    </p>

    <!-- Quick Stats -->
    <div class="grid grid-cols-3 gap-4 mt-12 max-w-xl mx-auto">
      <div class="bg-white rounded-lg p-4 shadow-sm">
        <div class="text-2xl font-bold text-breath-primary">60s</div>
        <div class="text-xs text-breath-muted mt-1"><span class="lang-en">Average time to calm</span><span class="lang-zh hidden">å¹³å‡å¹³å¤æ—¶é—´</span></div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm">
        <div class="text-2xl font-bold text-breath-primary">16</div>
        <div class="text-xs text-breath-muted mt-1"><span class="lang-en">Emotion types</span><span class="lang-zh hidden">æƒ…ç»ªç±»å‹</span></div>
      </div>
      <div class="bg-white rounded-lg p-4 shadow-sm">
        <div class="text-2xl font-bold text-breath-primary">0$</div>
        <div class="text-xs text-breath-muted mt-1"><span class="lang-en">Cost forever</span><span class="lang-zh hidden">æ°¸ä¹…å…è´¹</span></div>
      </div>
    </div>
  </section>

  <!-- App Container -->
  <div class="w-full max-w-2xl mx-auto px-4 pb-12">
    <div id="app" class="space-y-8">

      <!-- Screen 1: Weather Category Selection -->
      <div id="screen-weather" class="space-y-6">
        <header class="text-center space-y-2">
          <h2 class="text-2xl font-semibold text-breath-text">
            <span class="lang-en">How do you feel right now?</span><span class="lang-zh hidden">ç°åœ¨æ„Ÿè§‰åƒä»€ä¹ˆå¤©æ°”ï¼Ÿ</span>
          </h2>
        </header>

        <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto">
          <!-- Sunny -->
          <button class="weather-card p-4 rounded-2xl shadow-md transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-breath-primary focus:ring-offset-2"
                  style="background: linear-gradient(135deg, #FFF9E6 0%, #FFD700 100%);"
                  data-weather="sunny"
                  aria-label="Select Sunny weather for positive emotions">
            <div class="emoji sunny text-5xl mb-2">â˜€ï¸</div>
            <div class="text-base font-medium" style="color: #8B6914;"><span class="lang-en">Sunny</span><span class="lang-zh hidden">æ™´æœ—</span></div>
          </button>

          <!-- Cloudy -->
          <button class="weather-card p-4 rounded-2xl shadow-md transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-breath-primary focus:ring-offset-2"
                  style="background: linear-gradient(135deg, #E8E8E8 0%, #B0B0B0 100%);"
                  data-weather="cloudy"
                  aria-label="Select Cloudy weather for neutral or fatigued emotions">
            <div class="emoji cloudy text-5xl mb-2">â˜ï¸</div>
            <div class="text-base font-medium" style="color: #4A4A4A;"><span class="lang-en">Cloudy</span><span class="lang-zh hidden">å¤šäº‘</span></div>
          </button>

          <!-- Foggy -->
          <button class="weather-card p-4 rounded-2xl shadow-md transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-breath-primary focus:ring-offset-2"
                  style="background: linear-gradient(135deg, #E3F2F4 0%, #A8DADC 100%);"
                  data-weather="foggy"
                  aria-label="Select Foggy weather for anxiety or confusion">
            <div class="emoji foggy text-5xl mb-2">ğŸŒ«ï¸</div>
            <div class="text-base font-medium" style="color: #1D3557;"><span class="lang-en">Foggy</span><span class="lang-zh hidden">è¿·é›¾</span></div>
          </button>

          <!-- Stormy -->
          <button class="weather-card p-4 rounded-2xl shadow-md transition-all duration-200 hover:scale-105 focus:outline-none focus:ring-2 focus:ring-breath-primary focus:ring-offset-2"
                  style="background: linear-gradient(135deg, #E8D7F1 0%, #5A189A 100%);"
                  data-weather="stormy"
                  aria-label="Select Stormy weather for intense negative emotions">
            <div class="emoji stormy text-5xl mb-2">â›ˆï¸</div>
            <div class="text-base font-medium" style="color: #3D0066;"><span class="lang-en">Stormy</span><span class="lang-zh hidden">é£æš´</span></div>
          </button>
        </div>
      </div>

      <!-- Screen 2: Sub-Emotion Selection (populated dynamically) -->
      <div id="screen-sub-emotion" class="hidden space-y-6"></div>

      <!-- Screen 3: Intensity Bar -->
      <div id="screen-intensity" class="hidden space-y-6"></div>

      <!-- Screen 4: Trigger Text Field -->
      <div id="screen-trigger" class="hidden space-y-6">
        <header class="text-center space-y-2">
          <h2 class="text-2xl font-semibold text-breath-text">
            <span class="lang-en">What triggered this feeling?</span><span class="lang-zh hidden">æ˜¯ä»€ä¹ˆå¼•èµ·äº†è¿™ç§æ„Ÿè§‰ï¼Ÿ</span>
          </h2>
          <p class="text-base text-breath-muted">
            <span class="lang-en">(optional)</span><span class="lang-zh hidden">(å¯é€‰)</span>
          </p>
        </header>

        <textarea id="trigger-text"
                  class="w-full max-w-md mx-auto block p-4 border-2 border-breath-primary/30 rounded-lg focus:outline-none focus:border-breath-primary resize-none"
                  rows="3"
                  placeholder="e.g., 'Didn't hear back from her after texting'"
                  aria-label="Optional text field to describe what triggered your emotion"></textarea>

        <p class="text-sm text-breath-muted text-center max-w-md mx-auto">
          <span class="lang-en">This helps you spot patterns later.</span><span class="lang-zh hidden">è¿™æœ‰åŠ©äºä½ ä¹‹åå‘ç°æƒ…ç»ªæ¨¡å¼ã€‚</span>
        </p>

        <div class="flex gap-4 justify-center flex-wrap">
          <button id="btn-skip-trigger"
                  class="px-6 py-3 bg-transparent border-2 border-breath-primary text-breath-primary rounded-lg font-medium hover:bg-breath-primary/10 transition">
            <span class="lang-en">Skip</span><span class="lang-zh hidden">è·³è¿‡</span> â†’
          </button>
          <button id="btn-save-trigger"
                  class="px-6 py-3 bg-breath-primary text-white rounded-lg font-medium hover:bg-breath-primary/90 transition">
            <span class="lang-en">Save & Continue</span><span class="lang-zh hidden">ä¿å­˜å¹¶ç»§ç»­</span> â†’
          </button>
        </div>
      </div>

      <!-- Screen 5: Regulation Method Choice -->
      <div id="screen-method" class="hidden space-y-6">
        <header class="text-center space-y-2">
          <h2 class="text-2xl font-semibold text-breath-text">
            <span class="lang-en">How would you like to release it?</span><span class="lang-zh hidden">ä½ æƒ³å¦‚ä½•é‡Šæ”¾è¿™ä¸ªæƒ…ç»ªï¼Ÿ</span>
          </h2>
        </header>

        <div class="space-y-4 max-w-md mx-auto">
          <!-- Sedona Method -->
          <button class="method-card w-full p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition border-2 border-transparent hover:border-breath-primary text-left"
                  data-method="sedona">
            <div class="flex items-start gap-4">
              <div class="text-4xl">ğŸŒŠ</div>
              <div class="flex-1">
                <div class="text-lg font-semibold text-breath-text">Sedona Method</div>
                <div class="text-sm text-breath-muted mb-2"><span class="lang-en">Feel it, then let it go</span><span class="lang-zh hidden">æ„Ÿå—å®ƒï¼Œç„¶åæ”¾ä¸‹å®ƒ</span></div>
                <div class="text-sm text-breath-muted"><span class="lang-en">4 gentle questions</span><span class="lang-zh hidden">4ä¸ªæ¸©å’Œçš„é—®é¢˜</span> Â· â± 2-3 min</div>
              </div>
            </div>
          </button>

          <!-- Breathing Exercise -->
          <button class="method-card w-full p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition border-2 border-transparent hover:border-breath-primary text-left"
                  data-method="breathing">
            <div class="flex items-start gap-4">
              <div class="text-4xl">ğŸ«</div>
              <div class="flex-1">
                <div class="text-lg font-semibold text-breath-text"><span class="lang-en">Breathing Exercise</span><span class="lang-zh hidden">å‘¼å¸ç»ƒä¹ </span></div>
                <div class="text-sm text-breath-muted mb-2"><span class="lang-en">Follow the circle</span><span class="lang-zh hidden">è·Ÿç€åœ†åœˆå‘¼å¸</span></div>
                <div class="text-sm text-breath-muted"><span class="lang-en">3 cycles of calm breathing</span><span class="lang-zh hidden">3ä¸ªå¹³é™å‘¼å¸å¾ªç¯</span> Â· â± 60s</div>
              </div>
            </div>
          </button>

          <!-- Both -->
          <button class="method-card w-full p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition border-2 border-transparent hover:border-breath-primary text-left"
                  data-method="both">
            <div class="flex items-start gap-4">
              <div class="text-4xl">ğŸŒ€</div>
              <div class="flex-1">
                <div class="text-lg font-semibold text-breath-text"><span class="lang-en">Both (Sedona + Breathing)</span><span class="lang-zh hidden">ä¸¤è€…éƒ½è¯•è¯•</span></div>
                <div class="text-sm text-breath-muted mb-2"><span class="lang-en">Complete experience</span><span class="lang-zh hidden">å®Œæ•´ä½“éªŒ</span></div>
                <div class="text-sm text-breath-muted">â± 4-5 min</div>
              </div>
            </div>
          </button>

          <!-- Writing Release -->
          <button class="method-card w-full p-6 bg-white rounded-lg shadow-md hover:shadow-lg transition border-2 border-transparent hover:border-breath-primary text-left"
                  data-method="writing">
            <div class="flex items-start gap-4">
              <div class="text-4xl">âœï¸</div>
              <div class="flex-1">
                <div class="text-lg font-semibold text-breath-text"><span class="lang-en">Writing Release</span><span class="lang-zh hidden">ä¹¦å†™é‡Šæ”¾</span></div>
                <div class="text-sm text-breath-muted mb-2"><span class="lang-en">Put it into words</span><span class="lang-zh hidden">ç”¨æ–‡å­—æŠŠæ„Ÿå—å†™å‡ºæ¥</span></div>
                <div class="text-sm text-breath-muted"><span class="lang-en">2â€“5 min of free writing</span><span class="lang-zh hidden">2â€“5åˆ†é’Ÿè‡ªç”±ä¹¦å†™</span></div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <!-- Screen 6: Sedona Method (4 Questions) -->
      <div id="screen-sedona" class="hidden min-h-screen flex flex-col items-center justify-center py-12"></div>

      <!-- Screen 7: Writing Release -->
      <div id="screen-writing" class="hidden space-y-6"></div>

      <!-- Screen 8: Breathing Exercise -->
      <div id="screen-breathing" class="hidden space-y-6">
        <div class="text-center">
          <p class="text-base font-medium text-breath-text mb-4">
            <span class="lang-en">Follow the circle</span><span class="lang-zh hidden">è·Ÿç€åœ†åœˆå‘¼å¸</span>
          </p>
          <div class="text-sm text-breath-muted mb-4">
            <span class="cycle-dot inline-block w-2.5 h-2.5 rounded-full bg-breath-primary mx-1" id="cycle-1"></span>
            <span class="cycle-dot inline-block w-2.5 h-2.5 rounded-full bg-breath-muted/30 mx-1" id="cycle-2"></span>
            <span class="cycle-dot inline-block w-2.5 h-2.5 rounded-full bg-breath-muted/30 mx-1" id="cycle-3"></span>
          </div>
        </div>

        <section class="space-y-4">
          <div class="flex justify-center">
            <svg viewBox="0 0 200 200" class="breath-circle w-64 h-64">
              <circle cx="100" cy="100" r="90" fill="none" stroke="#E8EFF5" stroke-width="2" opacity="0.3"/>
              <circle cx="100" cy="100" r="40" class="breath-pulse" fill="url(#breathGradient)" stroke="#4A90E2" stroke-width="2">
                <animate attributeName="r" values="40;80;40" dur="10s" keyTimes="0;0.4;1" keySplines="0.4 0 0.2 1; 0.4 0 0.2 1" calcMode="spline" repeatCount="indefinite"/>
                <animate attributeName="opacity" values="0.7;1;0.7" dur="10s" keyTimes="0;0.4;1" repeatCount="indefinite"/>
              </circle>
              <defs>
                <radialGradient id="breathGradient">
                  <stop offset="0%" style="stop-color:#50C9B8;stop-opacity:0.8"/>
                  <stop offset="100%" style="stop-color:#4A90E2;stop-opacity:0.6"/>
                </radialGradient>
              </defs>
            </svg>
          </div>

          <div class="text-center space-y-1">
            <p class="text-lg font-medium text-breath-text breath-text" data-phase="inhale">
              <span class="lang-en">Breathe in...</span><span class="lang-zh hidden">å¸æ°”...</span>
            </p>
            <p class="text-lg font-medium text-breath-text breath-text opacity-0" data-phase="exhale">
              <span class="lang-en">Breathe out...</span><span class="lang-zh hidden">å‘¼æ°”...</span>
            </p>
          </div>
        </section>
      </div>

      <!-- Screen 9: After Rating -->
      <div id="screen-after" class="hidden space-y-6"></div>

      <!-- Screen 10: Success -->
      <div id="screen-success" class="hidden space-y-6">
        <div class="text-center space-y-4">
          <div class="text-6xl mb-4">âœ¨</div>
          <h2 class="text-3xl font-semibold text-breath-text"><span class="lang-en">You did great!</span><span class="lang-zh hidden">ä½ åšå¾—å¾ˆæ£’ï¼</span></h2>

          <div id="improvement-display" class="bg-white rounded-lg p-6 shadow-sm border-2 border-mood-after/30 space-y-2"></div>

          <div class="text-sm text-breath-muted space-y-1">
            <p><span class="lang-en">Take a moment. You deserve it.</span><span class="lang-zh hidden">ç»™è‡ªå·±ä¸€ç‚¹æ—¶é—´ï¼Œä½ å€¼å¾—ã€‚</span></p>
          </div>

          <button id="btn-again" class="w-full max-w-md mx-auto block py-3 px-4 bg-breath-primary hover:bg-breath-primary/90 text-white rounded-lg font-medium transition">
            <span class="lang-en">Again</span><span class="lang-zh hidden">å†æ¥ä¸€æ¬¡</span>
          </button>
        </div>
      </div>

    </div>
  </div>

  <!-- Screen Reader Accessibility -->
  <div aria-live="polite" aria-atomic="true" class="sr-only" id="sr-announcement"></div>

  <script>
    // ============================================================================
    // LANGUAGE TOGGLE
    // ============================================================================
    let currentLang = localStorage.getItem('double-mood-lang') || 'en';

    function applyLanguage(lang) {
      currentLang = lang;
      localStorage.setItem('double-mood-lang', lang);
      document.documentElement.lang = lang === 'zh' ? 'zh' : 'en';

      document.querySelectorAll('.lang-en').forEach(el => {
        if (lang === 'en') {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });

      document.querySelectorAll('.lang-zh').forEach(el => {
        if (lang === 'zh') {
          el.classList.remove('hidden');
        } else {
          el.classList.add('hidden');
        }
      });

      // Update textarea placeholder
      const triggerText = document.getElementById('trigger-text');
      if (triggerText) {
        triggerText.placeholder = lang === 'zh'
          ? 'ä¾‹å¦‚ï¼š"å‘æ¶ˆæ¯ç»™å¥¹ä¹‹åä¸€ç›´æ²¡æœ‰å›å¤"'
          : "e.g., 'Didn't hear back from her after texting'";
      }
    }

    function toggleLanguage() {
      applyLanguage(currentLang === 'en' ? 'zh' : 'en');
    }

    // Apply saved language on load
    applyLanguage(currentLang);

    // ============================================================================
    // EMOTION DATA (16 sub-emotions grouped by weather)
    // ============================================================================
    const EMOTIONS = {
      sunny: [
        { id: 'bright-sun', emoji: 'ğŸŒ', nameEn: 'Bright Sun', nameZh: 'æ™´æ—¥å½“ç©º', descriptor: 'Joy, excitement, achievement', descriptorZh: 'å–œæ‚¦ã€å…´å¥‹ã€æˆå°±æ„Ÿ', adjEn: 'joyful', adjZh: 'å¿«ä¹' },
        { id: 'warm-breeze', emoji: 'ğŸŒ¸', nameEn: 'Warm Breeze', nameZh: 'æ™´æš–å¾®é£', descriptor: 'Tenderness, contentment, feeling loved', descriptorZh: 'æ¸©æŸ”ã€æ»¡è¶³ã€è¢«çˆ±çš„æ„Ÿè§‰', adjEn: 'content', adjZh: 'æ»¡è¶³' },
        { id: 'partly-cloudy', emoji: 'ğŸŒ¤ï¸', nameEn: 'Partly Cloudy', nameZh: 'æ™´è½¬å¤šäº‘', descriptor: 'A bit happy but also tired', descriptorZh: 'æœ‰ç‚¹å¼€å¿ƒä½†ä¹Ÿæœ‰äº›ç–²æƒ«', adjEn: 'mixed', adjZh: 'å¤æ‚' },
        { id: 'rainbow', emoji: 'ğŸŒˆ', nameEn: 'Rainbow', nameZh: 'é›¨ååˆæ™´', descriptor: 'Relief, liberation, renewed hope', descriptorZh: 'é‡Šç„¶ã€è§£è„±ã€é‡ç‡ƒå¸Œæœ›', adjEn: 'relieved', adjZh: 'é‡Šç„¶' }
      ],
      cloudy: [
        { id: 'thin-clouds', emoji: 'â˜ï¸', nameEn: 'Thin Clouds', nameZh: 'è–„äº‘', descriptor: 'Bored, bland, numb', descriptorZh: 'æ— èŠã€ä¹å‘³ã€éº»æœ¨', adjEn: 'bored', adjZh: 'æ— èŠ' },
        { id: 'heavy-clouds', emoji: 'ğŸŒ¥ï¸', nameEn: 'Heavy Clouds', nameZh: 'åšäº‘', descriptor: 'Exhausted, burnt out, no energy', descriptorZh: 'ç²¾ç–²åŠ›å°½ã€ç‡ƒå°½ã€æ²¡æœ‰ç²¾åŠ›', adjEn: 'exhausted', adjZh: 'ç–²æƒ«' },
        { id: 'cloudy-to-rain', emoji: 'ğŸŒ¦ï¸', nameEn: 'Cloudy to Rain', nameZh: 'å¤šäº‘è½¬é›¨', descriptor: 'A bit down, want to cry but can\'t', descriptorZh: 'æœ‰ç‚¹ä½è½ï¼Œæƒ³å“­å´å“­ä¸å‡ºæ¥', adjEn: 'down', adjZh: 'ä½è½' },
        { id: 'scattered-clouds', emoji: 'ğŸŒªï¸', nameEn: 'Scattered Clouds', nameZh: 'ä¹±äº‘', descriptor: 'Racing thoughts, can\'t focus', descriptorZh: 'æ€ç»ªçº·ä¹±ï¼Œæ— æ³•é›†ä¸­', adjEn: 'scattered', adjZh: 'ç„¦èº' }
      ],
      foggy: [
        { id: 'light-fog', emoji: 'ğŸŒ«ï¸', nameEn: 'Light Fog', nameZh: 'è½»é›¾', descriptor: 'Mild anxiety, subtle unease', descriptorZh: 'è½»å¾®ç„¦è™‘ã€éšéšçš„ä¸å®‰', adjEn: 'uneasy', adjZh: 'ä¸å®‰' },
        { id: 'dense-fog', emoji: 'ğŸŒ«ï¸', nameEn: 'Dense Fog', nameZh: 'æµ“é›¾', descriptor: 'Strong anxiety, chest tightness, can\'t breathe', descriptorZh: 'å¼ºçƒˆç„¦è™‘ã€èƒ¸é—·ã€å–˜ä¸è¿‡æ°”', adjEn: 'anxious', adjZh: 'ç„¦è™‘' },
        { id: 'morning-fog', emoji: 'ğŸŒ«ï¸', nameEn: 'Morning Fog', nameZh: 'æ™¨é›¾', descriptor: 'Lost, don\'t know what to do next', descriptorZh: 'è¿·èŒ«ï¼Œä¸çŸ¥é“ä¸‹ä¸€æ­¥è¯¥æ€ä¹ˆåŠ', adjEn: 'lost', adjZh: 'è¿·èŒ«' },
        { id: 'night-fog', emoji: 'ğŸŒ«ï¸', nameEn: 'Night Fog', nameZh: 'å¤œé›¾', descriptor: 'Lonely, empty, self-doubt', descriptorZh: 'å­¤ç‹¬ã€ç©ºè™šã€è‡ªæˆ‘æ€€ç–‘', adjEn: 'lonely', adjZh: 'å­¤ç‹¬' }
      ],
      stormy: [
        { id: 'lightning', emoji: 'ğŸŒ©ï¸', nameEn: 'Lightning', nameZh: 'é—ªç”µ', descriptor: 'Rage, explosive anger', descriptorZh: 'æš´æ€’ã€çˆ†å‘æ€§çš„æ„¤æ€’', adjEn: 'angry', adjZh: 'æ„¤æ€’' },
        { id: 'downpour', emoji: 'ğŸŒ§ï¸', nameEn: 'Downpour', nameZh: 'æš´é›¨', descriptor: 'Breakdown crying, emotional flood', descriptorZh: 'å´©æºƒå¤§å“­ã€æƒ…ç»ªå†³å ¤', adjEn: 'overwhelmed', adjZh: 'å´©æºƒ' },
        { id: 'tornado', emoji: 'ğŸŒªï¸', nameEn: 'Tornado', nameZh: 'é¾™å·é£', descriptor: 'Loss of control, hysteria', descriptorZh: 'å¤±å»æ§åˆ¶ã€æ­‡æ–¯åº•é‡Œ', adjEn: 'out of control', adjZh: 'å¤±æ§' },
        { id: 'volcano', emoji: 'ğŸŒ‹', nameEn: 'Volcano', nameZh: 'ç«å±±', descriptor: 'Suppressed to the limit, about to erupt', descriptorZh: 'å‹æŠ‘åˆ°æé™ï¼Œå¿«è¦çˆ†å‘', adjEn: 'about to erupt', adjZh: 'å¿«è¦çˆ†å‘' }
      ]
    };

    const WEATHER_ICONS = {
      sunny: 'â˜€ï¸',
      cloudy: 'â˜ï¸',
      foggy: 'ğŸŒ«ï¸',
      stormy: 'â›ˆï¸'
    };

    const WEATHER_NAMES_ZH = {
      sunny: 'æ™´æœ—',
      cloudy: 'å¤šäº‘',
      foggy: 'è¿·é›¾',
      stormy: 'é£æš´'
    };

    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    const state = {
      sessionId: Date.now().toString(),
      timestamp: new Date().toISOString(),
      weatherCategory: null,
      subEmotion: null,
      intensityBefore: 5,
      trigger: '',
      regulationMethod: null,
      sedonaCycles: 0,
      sedonaCurrentQuestion: 1,
      breathingCycleCount: 0,
      intensityAfter: 5,
      improvementDelta: 0,
      durationSeconds: 0,
      startTime: null,
      writingNotes: ''
    };

    function saveSessions() {
      const stored = JSON.parse(localStorage.getItem('double-mood-sessions') || '[]');
      stored.push({
        id: state.sessionId,
        timestamp: state.timestamp,
        weatherCategory: state.weatherCategory,
        subEmotion: state.subEmotion,
        intensityBefore: state.intensityBefore,
        trigger: state.trigger,
        regulationMethod: state.regulationMethod,
        sedonaCycles: state.sedonaCycles,
        writingNotes: state.writingNotes,
        intensityAfter: state.intensityAfter,
        improvementDelta: state.improvementDelta,
        durationSeconds: state.durationSeconds
      });
      localStorage.setItem('double-mood-sessions', JSON.stringify(stored));
    }

    // ============================================================================
    // UI UTILITIES
    // ============================================================================
    function hideAllScreens() {
      document.querySelectorAll('[id^="screen-"]').forEach(el => el.classList.add('hidden'));
    }

    function showScreen(screenId) {
      hideAllScreens();
      const screen = document.getElementById(screenId);
      screen.classList.remove('hidden');
      screen.classList.add('screen-enter');
      setTimeout(() => screen.classList.remove('screen-enter'), 300);
    }

    function announceToScreenReader(message) {
      document.getElementById('sr-announcement').textContent = message;
    }

    function getIntensityGradient(value) {
      if (value <= 3) return 'linear-gradient(90deg, #81C784 0%, #50C9B8 100%)';
      if (value <= 7) return 'linear-gradient(90deg, #FFD54F 0%, #FFB74D 100%)';
      return 'linear-gradient(90deg, #FF8A65 0%, #E57373 100%)';
    }

    function getIntensityLabel(value) {
      if (value <= 3) return { en: 'a bit', zh: 'æœ‰ç‚¹' };
      if (value <= 7) return { en: 'quite', zh: 'ç›¸å½“' };
      return { en: 'very', zh: 'éå¸¸' };
    }

    // Helper: create bilingual span pair
    function langSpan(en, zh) {
      const enHidden = currentLang === 'zh' ? ' hidden' : '';
      const zhHidden = currentLang === 'en' ? ' hidden' : '';
      return `<span class="lang-en${enHidden}">${en}</span><span class="lang-zh${zhHidden}">${zh}</span>`;
    }

    // ============================================================================
    // SCREEN 1: WEATHER SELECTION
    // ============================================================================
    document.querySelectorAll('.weather-card').forEach(card => {
      card.addEventListener('click', () => {
        state.weatherCategory = card.dataset.weather;
        state.startTime = Date.now();
        announceToScreenReader(`Selected ${state.weatherCategory} weather`);
        renderSubEmotions();
        showScreen('screen-sub-emotion');
      });
    });

    // ============================================================================
    // SCREEN 2: SUB-EMOTION SELECTION
    // ============================================================================
    function renderSubEmotions() {
      const container = document.getElementById('screen-sub-emotion');
      const emotions = EMOTIONS[state.weatherCategory];
      const weatherIcon = WEATHER_ICONS[state.weatherCategory];
      const weatherZh = WEATHER_NAMES_ZH[state.weatherCategory];

      container.innerHTML = `
        <header class="flex items-center gap-4 mb-6">
          <div class="text-5xl">${weatherIcon}</div>
          <div>
            <h2 class="text-2xl font-semibold text-breath-text capitalize">
              ${langSpan(`${state.weatherCategory} â€” Which kind?`, `${weatherZh} â€” å“ªä¸€ç§ï¼Ÿ`)}
            </h2>
          </div>
        </header>

        <div class="space-y-3 max-w-lg mx-auto">
          ${emotions.map(e => `
            <button class="sub-emotion-card w-full p-4 bg-white rounded-lg shadow-md hover:shadow-lg transition border-2 border-transparent hover:border-breath-primary text-left"
                    data-emotion="${e.id}">
              <div class="flex items-start gap-3">
                <div class="text-3xl">${e.emoji}</div>
                <div>
                  <div class="text-lg font-semibold text-breath-text">${langSpan(e.nameEn, e.nameZh)}</div>
                  <div class="text-sm text-breath-muted italic mt-1">${langSpan(e.descriptor, e.descriptorZh)}</div>
                </div>
              </div>
            </button>
          `).join('')}
        </div>

        <button id="btn-back-weather" class="flex items-center gap-2 mx-auto mt-6 text-breath-muted hover:text-breath-primary transition">
          <span class="text-lg">â†</span>
          <span class="text-sm">${langSpan('Back to weather', 'è¿”å›å¤©æ°”é€‰æ‹©')}</span>
        </button>
      `;

      document.querySelectorAll('.sub-emotion-card').forEach(card => {
        card.addEventListener('click', () => {
          state.subEmotion = card.dataset.emotion;
          announceToScreenReader(`Selected ${card.querySelector('.text-lg').textContent}`);
          renderIntensityScreen();
          showScreen('screen-intensity');
        });
      });

      document.getElementById('btn-back-weather').addEventListener('click', () => {
        showScreen('screen-weather');
      });
    }

    // ============================================================================
    // SCREEN 3: INTENSITY BAR
    // ============================================================================
    function renderIntensityScreen() {
      const emotion = Object.values(EMOTIONS).flat().find(e => e.id === state.subEmotion);
      const container = document.getElementById('screen-intensity');

      container.innerHTML = `
        <header class="flex items-center gap-4 mb-6">
          <div class="text-5xl">${emotion.emoji}</div>
          <div>
            <h2 class="text-2xl font-semibold text-breath-text">
              ${langSpan(`${emotion.nameEn} â€” How strong?`, `${emotion.nameZh} â€” å¼ºåº¦å¦‚ä½•ï¼Ÿ`)}
            </h2>
          </div>
        </header>

        <div class="space-y-6 max-w-lg mx-auto">
          <div class="relative py-8">
            <div class="text-4xl font-bold text-breath-text text-center mb-4" id="intensity-value">5 / 10</div>
            <input type="range" id="intensity-slider" min="0" max="10" value="5" step="1"
                   class="w-full"
                   style="background: linear-gradient(90deg, #FFD54F 0%, #FFB74D 100%);"
                   aria-label="Emotional intensity level from 0 to 10"
                   aria-valuemin="0" aria-valuemax="10" aria-valuenow="5">
          </div>

          <div class="flex justify-between text-sm px-2">
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Mild', 'è½»å¾®')}</div>
            </div>
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Moderate', 'ä¸­ç­‰')}</div>
            </div>
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Intense', 'å¼ºçƒˆ')}</div>
            </div>
          </div>

          <div class="bg-breath-primary/5 rounded-lg p-4 text-center">
            <p class="text-lg text-breath-text" id="intensity-feedback">
              ${langSpan(`You're feeling quite ${emotion.adjEn}.`, `ä½ æ„Ÿåˆ°ç›¸å½“${emotion.adjZh}ã€‚`)}
            </p>
          </div>

          <button id="btn-continue-intensity" class="w-full py-3 bg-breath-primary text-white rounded-lg font-medium hover:bg-breath-primary/90 transition">
            ${langSpan('Continue', 'ç»§ç»­')}
          </button>
        </div>
      `;

      const slider = document.getElementById('intensity-slider');
      const valueDisplay = document.getElementById('intensity-value');
      const feedback = document.getElementById('intensity-feedback');

      function updateSliderDisplay(value) {
        state.intensityBefore = value;
        valueDisplay.textContent = `${value} / 10`;
        slider.style.background = getIntensityGradient(value);
        slider.value = value;

        const label = getIntensityLabel(value);
        feedback.innerHTML = langSpan(
          `You're feeling ${label.en} ${emotion.adjEn}.`,
          `ä½ æ„Ÿåˆ°${label.zh}${emotion.adjZh}ã€‚`
        );

        if (navigator.vibrate && [0, 5, 10].includes(value)) {
          navigator.vibrate(10);
        }
      }

      slider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        updateSliderDisplay(value);
      });

      // Keyboard support: Page Up/Down for +/-5, arrow keys for +/-1 (native)
      slider.addEventListener('keydown', (e) => {
        let newValue = parseInt(slider.value);

        if (e.key === 'PageUp') {
          e.preventDefault();
          newValue = Math.min(10, newValue + 5);
          updateSliderDisplay(newValue);
        } else if (e.key === 'PageDown') {
          e.preventDefault();
          newValue = Math.max(0, newValue - 5);
          updateSliderDisplay(newValue);
        }
      });

      document.getElementById('btn-continue-intensity').addEventListener('click', () => {
        showScreen('screen-trigger');
      });
    }

    // ============================================================================
    // SCREEN 4: TRIGGER TEXT (already in HTML)
    // ============================================================================
    document.getElementById('btn-skip-trigger').addEventListener('click', () => {
      state.trigger = '';
      showScreen('screen-method');
    });

    document.getElementById('btn-save-trigger').addEventListener('click', () => {
      state.trigger = document.getElementById('trigger-text').value;
      showScreen('screen-method');
    });

    // Auto-save trigger text
    document.getElementById('trigger-text').addEventListener('input', (e) => {
      state.trigger = e.target.value;
    });

    // ============================================================================
    // SCREEN 5: METHOD SELECTION (already in HTML)
    // ============================================================================
    document.querySelectorAll('.method-card').forEach(card => {
      card.addEventListener('click', () => {
        state.regulationMethod = card.dataset.method;

        if (state.regulationMethod === 'sedona' || state.regulationMethod === 'both') {
          renderSedonaQuestion(1);
          showScreen('screen-sedona');
        } else if (state.regulationMethod === 'breathing') {
          startBreathingExercise();
          showScreen('screen-breathing');
        } else if (state.regulationMethod === 'writing') {
          renderWritingScreen();
          showScreen('screen-writing');
        }
      });
    });

    // ============================================================================
    // SCREEN 6: SEDONA METHOD (4 Questions)
    // ============================================================================
    const SEDONA_QUESTIONS = [
      {
        en: 'Can you feel this emotion right now?',
        zh: 'ä½ ç°åœ¨èƒ½æ„Ÿå—åˆ°è¿™ä¸ªæƒ…ç»ªå—ï¼Ÿ',
        instructionEn: 'Just notice it. You don\'t have to change it.',
        instructionZh: 'åªéœ€è§‰å¯Ÿå®ƒã€‚ä¸å¿…æ”¹å˜å®ƒã€‚',
        buttons: [{ textEn: 'Yes, I feel it', textZh: 'æ˜¯çš„ï¼Œæˆ‘æ„Ÿå—åˆ°äº†', action: 'next' }]
      },
      {
        en: 'Would you let it go?',
        zh: 'ä½ æ„¿æ„æ”¾ä¸‹å®ƒå—ï¼Ÿ',
        instructionEn: 'This is about willingness, not ability.',
        instructionZh: 'è¿™æ˜¯å…³äºæ„æ„¿ï¼Œä¸æ˜¯èƒ½åŠ›ã€‚',
        buttons: [{ textEn: 'Yes', textZh: 'æ„¿æ„', action: 'next' }, { textEn: 'Not yet', textZh: 'è¿˜æ²¡å‡†å¤‡å¥½', action: 'next' }]
      },
      {
        en: 'Could you let it go?',
        zh: 'ä½ èƒ½æ”¾ä¸‹å®ƒå—ï¼Ÿ',
        instructionEn: 'Not "should you," but "can you?" There\'s no wrong answer.',
        instructionZh: 'ä¸æ˜¯"åº”è¯¥å—"ï¼Œè€Œæ˜¯"èƒ½å—"ï¼Ÿæ²¡æœ‰é”™è¯¯çš„ç­”æ¡ˆã€‚',
        buttons: [{ textEn: 'Yes', textZh: 'å¯ä»¥', action: 'next' }, { textEn: 'Not yet', textZh: 'è¿˜ä¸è¡Œ', action: 'next' }]
      },
      {
        en: 'When?',
        zh: 'ä»€ä¹ˆæ—¶å€™ï¼Ÿ',
        instructionEn: 'When will you let it go?',
        instructionZh: 'ä½ ä»€ä¹ˆæ—¶å€™æ”¾ä¸‹å®ƒï¼Ÿ',
        buttons: [{ textEn: 'Now', textZh: 'ç°åœ¨', action: 'complete' }, { textEn: 'Repeat cycle', textZh: 'å†æ¥ä¸€è½®', action: 'repeat' }]
      }
    ];

    function renderSedonaQuestion(questionNum) {
      const q = SEDONA_QUESTIONS[questionNum - 1];
      const container = document.getElementById('screen-sedona');

      container.innerHTML = `
        <div class="sedona-wave text-6xl mb-8">ğŸŒŠ</div>
        <div class="max-w-lg mx-auto text-center space-y-8">
          <div>
            <h1 class="text-3xl font-medium text-breath-text mb-2">
              ${langSpan(q.en, q.zh)}
            </h1>
          </div>

          <div class="text-breath-muted space-y-3">
            <p>${langSpan(q.instructionEn, q.instructionZh)}</p>
            <p>${langSpan(
              'You can close your eyes now, take a deep breath, and allow yourself to feel.',
              'ä½ å¯ä»¥ç°åœ¨é—­ä¸Šçœ¼ç›ï¼Œæ·±å‘¼å¸ä¸€ä¸‹ï¼Œå…è®¸è‡ªå·±å¥½å¥½æ„Ÿå—å½“ä¸‹çš„æƒ…ç»ªã€‚'
            )}</p>
          </div>

          <div class="flex gap-4 justify-center flex-wrap sedona-buttons">
            ${q.buttons.map(btn => `
              <button class="sedona-btn px-8 py-3 ${btn.action === 'complete' ? 'bg-breath-primary text-white' : 'bg-transparent border-2 border-breath-primary text-breath-primary'} rounded-lg font-medium hover:opacity-90 transition"
                      data-action="${btn.action}">
                ${langSpan(btn.textEn, btn.textZh)} â†’
              </button>
            `).join('')}
          </div>
        </div>
      `;

      state.sedonaCurrentQuestion = questionNum;

      // Focus first button for keyboard accessibility
      setTimeout(() => {
        const firstBtn = document.querySelector('.sedona-btn');
        if (firstBtn) {
          firstBtn.focus();
        }
      }, 0);

      document.querySelectorAll('.sedona-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;

          if (action === 'next') {
            if (questionNum < 4) {
              renderSedonaQuestion(questionNum + 1);
            }
          } else if (action === 'repeat') {
            state.sedonaCycles++;
            renderSedonaQuestion(1);
          } else if (action === 'complete') {
            if (state.regulationMethod === 'both') {
              startBreathingExercise();
              showScreen('screen-breathing');
            } else {
              renderAfterScreen();
              showScreen('screen-after');
            }
          }
        });
      });
    }

    // ============================================================================
    // SCREEN 7: WRITING RELEASE
    // ============================================================================
    function renderWritingScreen() {
      const emotion = Object.values(EMOTIONS).flat().find(e => e.id === state.subEmotion);
      const container = document.getElementById('screen-writing');

      container.innerHTML = `
        <header class="text-center space-y-3">
          <div class="text-4xl mb-1">âœï¸</div>
          <h2 class="text-2xl font-semibold text-breath-text">
            ${langSpan('Writing Release', 'ä¹¦å†™é‡Šæ”¾')}
          </h2>
          <p class="text-sm text-breath-muted max-w-md mx-auto">
            ${langSpan(
              'Write freely for a few minutes. Donâ€™t worry about grammar or perfection.',
              'æ¥ä¸‹æ¥å‡ åˆ†é’Ÿï¼Œéšå¿ƒæ‰€æ¬²åœ°å†™ä¸‹ä½ çš„æ„Ÿå—ï¼Œä¸ç”¨åœ¨æ„è¯­æ³•æˆ–æ˜¯å¦å†™å¾—å¥½ã€‚'
            )}
          </p>
        </header>

        <section class="space-y-4 max-w-lg mx-auto">
          <div class="bg-white rounded-lg p-4 shadow-sm border border-breath-primary/20">
            <p class="text-sm font-medium text-breath-text mb-2">
              ${langSpan('You can start with:', 'ä½ å¯ä»¥ä»è¿™äº›å¥å­å¼€å§‹ï¼š')}
            </p>
            <ul class="text-sm text-breath-muted space-y-1 list-disc list-inside">
              <li>${langSpan('What hurts me the most isâ€¦', 'ç°åœ¨æœ€è®©æˆ‘éš¾å—çš„æ˜¯â€¦â€¦')}</li>
              <li>${langSpan('What I fear the most isâ€¦', 'æˆ‘æœ€å®³æ€•çš„æ˜¯â€¦â€¦')}</li>
              <li>${langSpan('What I need right now isâ€¦', 'æˆ‘ç°åœ¨æœ€éœ€è¦çš„æ˜¯â€¦â€¦')}</li>
            </ul>
          </div>

          <textarea
            id="writing-notes"
            class="w-full block p-4 border-2 border-breath-primary/30 rounded-lg focus:outline-none focus:border-breath-primary resize-none min-h-[180px]"
            placeholder="..."
            aria-label="Free writing area for your thoughts"></textarea>

          <button
            id="btn-complete-writing"
            class="w-full py-3 bg-breath-primary text-white rounded-lg font-medium hover:bg-breath-primary/90 transition">
            ${langSpan('Iâ€™m done writing', 'æˆ‘å†™å®Œäº†')}
          </button>
        </section>
      `;

      const textarea = document.getElementById('writing-notes');
      if (textarea) {
        textarea.value = state.writingNotes || '';
        textarea.addEventListener('input', (e) => {
          state.writingNotes = e.target.value;
        });
      }

      const completeBtn = document.getElementById('btn-complete-writing');
      if (completeBtn) {
        completeBtn.addEventListener('click', () => {
          renderAfterScreen();
          showScreen('screen-after');
        });
      }
    }

    // ============================================================================
    // SCREEN 8: BREATHING EXERCISE
    // ============================================================================
    const BREATH_CYCLE = 10000;
    const INHALE_DURATION = 4000;
    const TOTAL_CYCLES = 3;
    let breathingIntervalId = null;
    let breathingStartTime = null;

    function startBreathingExercise() {
      state.breathingCycleCount = 0;
      breathingStartTime = Date.now();
      updateBreathingCue();

      breathingIntervalId = setInterval(() => {
        const elapsed = Date.now() - breathingStartTime;
        const cycleIndex = Math.floor(elapsed / BREATH_CYCLE);
        state.breathingCycleCount = cycleIndex + 1;

        document.querySelectorAll('.cycle-dot').forEach((dot, i) => {
          if (i < state.breathingCycleCount) {
            dot.classList.remove('bg-breath-muted/30');
            dot.classList.add('bg-breath-primary');
          }
        });

        updateBreathingCue();

        if (state.breathingCycleCount >= TOTAL_CYCLES) {
          clearInterval(breathingIntervalId);
          setTimeout(() => {
            renderAfterScreen();
            showScreen('screen-after');
          }, 500);
        }
      }, 100);
    }

    function updateBreathingCue() {
      const now = Date.now() % BREATH_CYCLE;
      const isInhale = now < INHALE_DURATION;

      document.querySelectorAll('[data-phase="inhale"]').forEach(el => {
        el.style.opacity = isInhale ? '1' : '0';
      });

      document.querySelectorAll('[data-phase="exhale"]').forEach(el => {
        el.style.opacity = isInhale ? '0' : '1';
      });
    }

    // ============================================================================
    // SCREEN 8: AFTER RATING
    // ============================================================================
    function renderAfterScreen() {
      const emotion = Object.values(EMOTIONS).flat().find(e => e.id === state.subEmotion);
      const container = document.getElementById('screen-after');

      container.innerHTML = `
        <div class="bg-mood-before/10 border-l-4 border-mood-before rounded-lg p-4 mb-6 max-w-lg mx-auto">
          <span class="text-sm font-medium text-breath-text">${langSpan('Before:', 'ä¹‹å‰:')}</span>
          <span class="text-sm text-breath-muted ml-2">${emotion.emoji} ${langSpan(emotion.nameEn, emotion.nameZh)} â€” ${state.intensityBefore}/10</span>
        </div>

        <header class="text-center mb-6">
          <h2 class="text-2xl font-semibold text-breath-text">${langSpan('How are you feeling now?', 'ä½ ç°åœ¨æ„Ÿè§‰å¦‚ä½•ï¼Ÿ')}</h2>
        </header>

        <div class="space-y-6 max-w-lg mx-auto">
          <div class="relative py-8">
            <div class="text-4xl font-bold text-breath-text text-center mb-4" id="after-value">5 / 10</div>
            <input type="range" id="after-slider" min="0" max="10" value="5" step="1"
                   class="w-full"
                   style="background: linear-gradient(90deg, #FFD54F 0%, #FFB74D 100%);"
                   aria-label="Emotional intensity after regulation"
                   aria-valuemin="0" aria-valuemax="10" aria-valuenow="5">
          </div>

          <div class="flex justify-between text-sm px-2">
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Mild', 'è½»å¾®')}</div>
            </div>
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Moderate', 'ä¸­ç­‰')}</div>
            </div>
            <div class="text-center">
              <div class="font-medium text-breath-text">${langSpan('Intense', 'å¼ºçƒˆ')}</div>
            </div>
          </div>

          <div class="bg-breath-primary/5 rounded-lg p-4 text-center" id="after-feedback">
            <p class="text-lg text-breath-text">${langSpan("You're feeling lighter.", 'ä½ æ„Ÿåˆ°è½»æ¾äº†ã€‚')}</p>
          </div>

          <button id="btn-complete" class="w-full py-3 bg-mood-after text-white rounded-lg font-medium hover:bg-mood-after/90 transition">
            ${langSpan('Complete', 'å®Œæˆ')}
          </button>
        </div>
      `;

      const slider = document.getElementById('after-slider');
      const valueDisplay = document.getElementById('after-value');
      const feedbackBox = document.getElementById('after-feedback');

      function updateAfterSliderDisplay(value) {
        state.intensityAfter = value;
        valueDisplay.textContent = `${value} / 10`;
        slider.style.background = getIntensityGradient(value);
        slider.value = value;

        const delta = value - state.intensityBefore;
        let textEn, textZh, bgColor;

        if (delta <= -3) {
          textEn = "You're feeling much lighter.";
          textZh = "ä½ æ„Ÿåˆ°è½»æ¾å¤šäº†ã€‚";
          bgColor = 'rgba(80, 201, 184, 0.1)';
        } else if (delta <= -1) {
          textEn = "You're feeling a bit better.";
          textZh = "ä½ æ„Ÿåˆ°å¥½ä¸€äº›äº†ã€‚";
          bgColor = 'rgba(74, 144, 226, 0.05)';
        } else if (delta >= -1 && delta <= 1) {
          textEn = "That's okay. Sometimes it takes time.";
          textZh = "æ²¡å…³ç³»ï¼Œæœ‰æ—¶å€™éœ€è¦æ—¶é—´ã€‚";
          bgColor = 'rgba(74, 144, 226, 0.05)';
        } else {
          textEn = "Still tough, huh? You're doing your best.";
          textZh = "è¿˜æ˜¯å¾ˆéš¾å—ï¼Ÿä½ å·²ç»å°½åŠ›äº†ã€‚";
          bgColor = 'rgba(255, 183, 77, 0.1)';
        }

        feedbackBox.innerHTML = `
          <p class="text-lg text-breath-text">${langSpan(textEn, textZh)}</p>
        `;
        feedbackBox.style.background = bgColor;

        if (navigator.vibrate && [0, 5, 10].includes(value)) {
          navigator.vibrate(10);
        }
      }

      slider.addEventListener('input', (e) => {
        const value = parseInt(e.target.value);
        updateAfterSliderDisplay(value);
      });

      // Keyboard support: Page Up/Down for +/-5, arrow keys for +/-1 (native)
      slider.addEventListener('keydown', (e) => {
        let newValue = parseInt(slider.value);

        if (e.key === 'PageUp') {
          e.preventDefault();
          newValue = Math.min(10, newValue + 5);
          updateAfterSliderDisplay(newValue);
        } else if (e.key === 'PageDown') {
          e.preventDefault();
          newValue = Math.max(0, newValue - 5);
          updateAfterSliderDisplay(newValue);
        }
      });

      document.getElementById('btn-complete').addEventListener('click', () => {
        state.improvementDelta = state.intensityAfter - state.intensityBefore;
        state.durationSeconds = Math.floor((Date.now() - state.startTime) / 1000);
        saveSessions();
        renderSuccessScreen();
        showScreen('screen-success');
      });
    }

    // ============================================================================
    // SCREEN 9: SUCCESS
    // ============================================================================
    function renderSuccessScreen() {
      const container = document.getElementById('improvement-display');
      const delta = state.improvementDelta;

      let displayTextEn, displayTextZh, color;
      if (delta <= -1) {
        displayTextEn = `${Math.abs(delta)} points better`;
        displayTextZh = `æ”¹å–„äº† ${Math.abs(delta)} åˆ†`;
        color = 'text-mood-after';
      } else if (delta === 0) {
        displayTextEn = 'No change';
        displayTextZh = 'æ²¡æœ‰å˜åŒ–';
        color = 'text-breath-primary';
      } else {
        displayTextEn = `+${delta} points`;
        displayTextZh = `+${delta} åˆ†`;
        color = 'text-breath-muted';
      }

      container.innerHTML = `
        <p class="text-sm text-breath-muted">${langSpan('Improvement', 'æ”¹å–„æƒ…å†µ')}</p>
        <p class="text-4xl font-bold ${color}">${langSpan(displayTextEn, displayTextZh)}</p>
        <p class="text-sm text-breath-muted">${langSpan("You're doing great", 'ä½ åšå¾—å¾ˆå¥½')}</p>
      `;
    }

    document.getElementById('btn-again').addEventListener('click', () => {
      // Reset state
      state.sessionId = Date.now().toString();
      state.timestamp = new Date().toISOString();
      state.weatherCategory = null;
      state.subEmotion = null;
      state.intensityBefore = 5;
      state.trigger = '';
      state.regulationMethod = null;
      state.sedonaCycles = 0;
      state.writingNotes = '';
      state.intensityAfter = 5;
      state.improvementDelta = 0;
      state.durationSeconds = 0;
      state.startTime = null;

      document.getElementById('trigger-text').value = '';
      showScreen('screen-weather');
      announceToScreenReader('Ready for another session.');
    });

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    showScreen('screen-weather');
    announceToScreenReader('Double Mood app loaded. Select how you feel right now.');
  </script>

<!-- Cloudflare Web Analytics -->
<script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "d373debf0c0e4b8cbc752883cd00c8cb"}'></script>
<!-- End Cloudflare Web Analytics -->
</body>
</html>
